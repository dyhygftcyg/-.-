<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø© - Global Phone System</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #00d2ff; --success: #00ff88; --danger: #ff416c; 
            --warning: #ffb100; --card-bg: rgba(15, 23, 42, 0.8); 
        }

        body { 
            font-family: 'Cairo', sans-serif; margin: 0; padding: 15px; 
            color: white; min-height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                        url('https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?q=80&w=2000&auto=format&fit=crop'); 
            background-size: cover; background-position: center; background-attachment: fixed;
        }

        .glass { 
            background: var(--card-bg); backdrop-filter: blur(15px);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); padding: 20px;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-item { text-align: center; padding: 15px; border-radius: 15px; transition: 0.3s; border-bottom: 3px solid transparent; }
        .stat-item:hover { transform: translateY(-5px); background: rgba(255,255,255,0.05); }

        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        
        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3);
            color: white; outline: none; font-size: 14px;
        }

        button { 
            cursor: pointer; border: none; border-radius: 10px; font-weight: bold; 
            transition: 0.2s; active { transform: scale(0.95); }
        }

        .btn-main { background: linear-gradient(90deg, #00d2ff, #3a7bd5); color: white; padding: 12px; width: 100%; }
        .btn-buy { background: var(--success); color: #000; padding: 5px 10px; font-size: 12px; }
        .btn-sell { background: var(--primary); color: #000; padding: 5px 10px; font-size: 12px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: right; color: var(--primary); padding: 15px 10px; border-bottom: 2px solid rgba(255,255,255,0.1); }
        td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .low-stock { color: var(--danger); font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        #loginOverlay { 
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }

        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="glass" style="width: 300px; text-align: center;">
        <h2 style="color: var(--primary)">AL-MADINA</h2>
        <input type="password" id="passIn" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„">
        <button class="btn-main" onclick="login()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
</div>

<div id="mainApp" style="display:none">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h1 style="margin:0; font-size: 24px; letter-spacing: 1px;">AL-MADINA <span style="color: var(--primary)">SMART SYSTEM</span></h1>
        <div style="display: flex; gap: 10px;">
            <button onclick="exportToPDF()" style="background: white; color: black; padding: 8px 15px;">PDF</button>
            <button onclick="location.reload()" style="background: var(--danger); color: white; padding: 8px 15px;">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="stats-grid">
        <div class="glass stat-item" style="border-color: var(--success)"><h4>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h4><p id="statSales" style="color: var(--success)">0</p></div>
        <div class="glass stat-item" style="border-color: var(--danger)"><h4>Ø¯ÙŠÙˆÙ† Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h4><p id="statDebtsTo" style="color: var(--danger)">0</p></div>
        <div class="glass stat-item" style="border-color: var(--warning)"><h4>Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h4><p id="statDebtsFor" style="color: var(--warning)">0</p></div>
        <div class="glass stat-item" style="border-color: var(--primary)"><h4>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h4><p id="statInv" style="color: var(--primary)">0</p></div>
    </div>

    <div class="main-layout">
        <aside>
            <div class="glass" style="margin-bottom: 20px;">
                <h3 style="margin-top:0">ğŸ“¦ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>
                <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù‚Ø·Ø¹Ø©">
                <input type="number" id="pCost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
                <input type="number" id="pPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
                <input type="number" id="pQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©">
                <button class="btn-main" onclick="addItem()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
            </div>

            <div class="glass">
                <h3 style="margin-top:0">ğŸ“ Ø­Ø±ÙƒØ© Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
                <input type="text" id="debtName" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input type="number" id="debtAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <select id="debtType">
                    <option value="Ø¹Ù„ÙŠÙ‡">Ø¹Ù„ÙŠÙ‡ (Ø£Ø±ÙŠØ¯ Ù…Ù†Ù‡)</option>
                    <option value="Ù„Ù‡">Ù„Ù‡ (ÙŠØ±ÙŠØ¯ Ù…Ù†ÙŠ)</option>
                </select>
                <button style="background: var(--warning); color: black; padding:12px; width:100%" onclick="saveGeneralDebt()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†</button>
            </div>
        </aside>

        <main>
            <div id="pdfContent" class="glass">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin:0">ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                    <input type="text" id="searchBox" onkeyup="render()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù‡Ø§Ø²..." style="width:200px">
                </div>
                <table id="invTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ø¨ÙŠØ¹</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</th>
                            <th>Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="glass" style="margin-top: 20px;">
                <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                <table id="logsTable">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0UM5ITWjtqMFPwAEcVFZbMu4831d_6p0",
      authDomain: "al-madin.firebaseapp.com",
      databaseURL: "https://al-mad-default-rtdb.firebaseio.com",
      projectId: "al-madin",
      storageBucket: "al-madin.firebasestorage.app",
      messagingSenderId: "961981230421",
      appId: "1:961981230421:web:7dfc74e98c4330e99813dc"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('almadina_global_v6');

    let db = { inventory: [], sales: [], debts: [] };

    function login() {
        if(document.getElementById('passIn').value === "009944") {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            startSync();
        } else { alert("Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦!"); }
    }

    function startSync() {
        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) { db = data; render(); }
        });
    }

    function addItem() {
        const name = document.getElementById('pName').value;
        const cost = parseFloat(document.getElementById('pCost').value);
        const price = parseFloat(document.getElementById('pPrice').value);
        const qty = parseInt(document.getElementById('pQty').value) || 0;
        if(!name || !price) return;
        if(!db.inventory) db.inventory = [];
        db.inventory.push({ name, cost, price, qty });
        dbRef.set(db);
        ['pName','pCost','pPrice','pQty'].forEach(id => document.getElementById(id).value = '');
    }

    function quickTrade(index, type) {
        const item = db.inventory[index];
        if(type === 'sell') {
            if(item.qty > 0) {
                item.qty--;
                if(!db.sales) db.sales = [];
                db.sales.push({ name: item.name, paid: item.price, date: new Date().toLocaleString() });
            } else { alert("Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº!"); return; }
        } else {
            item.qty++;
        }
        dbRef.set(db);
    }

    function saveGeneralDebt() {
        const name = document.getElementById('debtName').value;
        const amount = parseFloat(document.getElementById('debtAmt').value);
        const type = document.getElementById('debtType').value;
        if(!name || !amount) return;
        if(!db.debts) db.debts = [];
        db.debts.push({ name, amount, type, date: new Date().toLocaleDateString() });
        dbRef.set(db);
        document.getElementById('debtName').value=''; document.getElementById('debtAmt').value='';
    }

    function collectDebt(index) {
        const d = db.debts[index];
        if(!db.sales) db.sales = [];
        db.sales.push({ name: "ØªØ­ØµÙŠÙ„: " + d.name, paid: d.amount, date: new Date().toLocaleString() });
        db.debts.splice(index, 1);
        dbRef.set(db);
    }

    function deleteLog(type, index) {
        if(confirm("Ø­Ø°ÙØŸ")) { db[type].splice(index, 1); dbRef.set(db); }
    }

    function exportToPDF() {
        const element = document.getElementById('pdfContent');
        html2pdf().from(element).save('ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©_Ø§Ù„Ù…Ù†ÙˆØ±Ø©.pdf');
    }

    function render() {
        const search = document.getElementById('searchBox').value.toLowerCase();
        
        // Ø±Ù†Ø¯Ø± Ø§Ù„Ù…Ø®Ø²Ù†
        document.querySelector('#invTable tbody').innerHTML = (db.inventory || [])
            .map((it, i) => ({...it, id: i}))
            .filter(it => it.name.toLowerCase().includes(search))
            .map(it => `
                <tr>
                    <td>${it.name}</td>
                    <td class="${it.qty < 3 ? 'low-stock' : ''}">${it.qty}</td>
                    <td>${it.price.toLocaleString()}</td>
                    <td>
                        <button class="btn-sell" onclick="quickTrade(${it.id}, 'sell')">Ø¨ÙŠØ¹ -1</button>
                        <button class="btn-buy" onclick="quickTrade(${it.id}, 'buy')">Ø´Ø±Ø§Ø¡ +1</button>
                    </td>
                    <td><button onclick="deleteLog('inventory', ${it.id})" style="background:none; color:var(--danger)">ğŸ—‘ï¸</button></td>
                </tr>`).join('');

        // Ø±Ù†Ø¯Ø± Ø§Ù„Ø¯ÙŠÙˆÙ†
        document.querySelector('#logsTable tbody').innerHTML = (db.debts || []).map((d, i) => `
            <tr>
                <td>${d.date}</td>
                <td>${d.name}</td>
                <td>${d.amount.toLocaleString()}</td>
                <td style="color:${d.type=='Ù„Ù‡'?'var(--success)':'var(--danger)'}">${d.type}</td>
                <td>
                    <button onclick="collectDebt(${i})">âœ…</button>
                    <button onclick="deleteLog('debts', ${i})">ğŸ—‘ï¸</button>
                </td>
            </tr>`).join('');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        const sales = (db.sales || []).reduce((s,i)=>s+i.paid, 0);
        const dTo = (db.debts || []).filter(d=>d.type=='Ø¹Ù„ÙŠÙ‡').reduce((s,i)=>s+i.amount, 0);
        const dFor = (db.debts || []).filter(d=>d.type=='Ù„Ù‡').reduce((s,i)=>s+i.amount, 0);
        const invValue = (db.inventory || []).reduce((s,i)=>s+(i.price*i.qty), 0);

        document.getElementById('statSales').innerText = sales.toLocaleString() + " Ø¬.Ø³";
        document.getElementById('statDebtsTo').innerText = dTo.toLocaleString() + " Ø¬.Ø³";
        document.getElementById('statDebtsFor').innerText = dFor.toLocaleString() + " Ø¬.Ø³";
        document.getElementById('statInv').innerText = invValue.toLocaleString() + " Ø¬.Ø³";
    }
</script>
</body>
</html>
